<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeBron Fighter - The King's Court</title>
    <link rel="icon" type="image/png" href="coolbrongames.png">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Firebase (Local) - Scripts served from repository, not CDN -->
    <script src="firebase-app-compat.js"></script>
    <script src="firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }

        #gameContainer {
            position: relative;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        canvas {
            display: block;
            background: linear-gradient(to bottom, #2c3e50 0%, #34495e 50%, #8b4513 100%);
            border: 8px solid #fdb927;
            box-shadow: 0 0 50px rgba(253, 185, 39, 0.5);
            width: 100%;
            max-width: 1200px;
            height: 600px;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        #startScreen, #roundScreen, #endScreen, #mainMenu, #shopScreen, #levelSelect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10;
            padding: 20px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 3rem;
            color: #fdb927;
            text-shadow: 4px 4px #552583;
            margin-bottom: 30px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 4px 4px #552583, 0 0 20px #fdb927; }
            50% { text-shadow: 4px 4px #552583, 0 0 40px #fdb927; }
        }

        .title-small {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        button {
            background: #552583;
            color: #fdb927;
            border: 4px solid #fdb927;
            padding: 15px 40px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        button:hover {
            background: #fdb927;
            color: #552583;
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        .controls {
            background: rgba(85, 37, 131, 0.3);
            border: 2px solid #fdb927;
            padding: 20px;
            border-radius: 10px;
            margin: 20px;
            max-width: 800px;
        }

        .controls h3 {
            color: #fdb927;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
            font-size: 0.7rem;
            line-height: 1.8;
        }

        .player-label {
            color: #fdb927;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 5;
        }

        .health-container {
            flex: 1;
            max-width: 45%;
        }

        .health-label {
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .health-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 3px solid #fdb927;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000 0%, #ff6600 50%, #00ff00 100%);
            transition: width 0.3s ease;
            position: relative;
        }

        .special-meter {
            height: 10px;
            background: #333;
            border: 2px solid #fdb927;
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }

        .special-fill {
            height: 100%;
            background: linear-gradient(90deg, #fdb927 0%, #ff6600 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .center-hud {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .timer {
            font-size: 2rem;
            color: #fdb927;
            text-shadow: 2px 2px #552583;
        }

        .round-indicator {
            font-size: 1rem;
            color: #fff;
        }

        .wins-display {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .win-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid #fdb927;
            background: #333;
        }

        .win-dot.won {
            background: #fdb927;
        }

        .combo-display {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            color: #fdb927;
            text-shadow: 3px 3px #552583;
            animation: comboAnim 0.5s ease;
            z-index: 6;
        }

        @keyframes comboAnim {
            0% { transform: translateX(-50%) scale(0); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .victory-text {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #fdb927;
        }

        /* Touch Controls */
        #touchControls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            display: none;
            z-index: 8;
            pointer-events: none;
        }

        #touchControls.active {
            display: block;
            pointer-events: auto;
        }

        .touch-button {
            position: absolute;
            background: rgba(85, 37, 131, 0.7);
            border: 3px solid #fdb927;
            border-radius: 50%;
            color: #fdb927;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
            cursor: pointer;
            transition: all 0.1s;
        }

        .touch-button:active {
            background: rgba(253, 185, 39, 0.9);
            color: #552583;
            transform: scale(0.95);
        }

        .touch-button.square {
            border-radius: 10px;
        }

        /* Left D-pad */
        .dpad-up { bottom: 120px; left: 70px; width: 50px; height: 50px; }
        .dpad-down { bottom: 20px; left: 70px; width: 50px; height: 50px; }
        .dpad-left { bottom: 70px; left: 20px; width: 50px; height: 50px; }
        .dpad-right { bottom: 70px; left: 120px; width: 50px; height: 50px; }

        /* Right action buttons */
        .btn-punch { bottom: 120px; right: 120px; width: 60px; height: 60px; }
        .btn-kick { bottom: 70px; right: 50px; width: 60px; height: 60px; }
        .btn-block { bottom: 20px; right: 120px; width: 60px; height: 60px; }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 800px;
            margin: 20px auto;
        }

        .shop-item {
            background: rgba(85, 37, 131, 0.3);
            border: 3px solid #fdb927;
            padding: 15px;
            border-radius: 10px;
        }

        .shop-item h4 {
            font-size: 0.9rem;
            color: #fdb927;
            margin-bottom: 10px;
        }

        .shop-item p {
            font-size: 0.7rem;
            margin: 5px 0;
        }

        .shop-item button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 0.7rem;
        }

        .coins-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(85, 37, 131, 0.9);
            border: 3px solid #fdb927;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            color: #fdb927;
            z-index: 100;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
        }

        .level-button {
            padding: 20px;
            font-size: 1.2rem;
            background: #552583;
            position: relative;
        }

        .level-button.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-button .difficulty {
            font-size: 0.6rem;
            margin-top: 5px;
            display: block;
        }

        .stats-panel {
            background: rgba(85, 37, 131, 0.3);
            border: 3px solid #fdb927;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
        }

        .stats-panel h3 {
            color: #fdb927;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .stat-bar {
            margin: 10px 0;
        }

        .stat-bar label {
            font-size: 0.7rem;
            display: block;
            margin-bottom: 5px;
        }

        .stat-bar-fill {
            height: 20px;
            background: linear-gradient(90deg, #fdb927 0%, #ff6600 100%);
            border: 2px solid #fdb927;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .title-small { font-size: 1.2rem; }
            button { font-size: 0.7rem; padding: 10px 20px; }
            .controls { padding: 10px; margin: 10px; }
            .control-grid { font-size: 0.5rem; gap: 10px; }
            canvas { height: 400px; }
            .coins-display { font-size: 0.9rem; padding: 8px 15px; top: 10px; right: 10px; }
            .shop-grid, .level-grid { grid-template-columns: 1fr; }
            .shop-item h4 { font-size: 0.7rem; }
            .shop-item p { font-size: 0.6rem; }
            
            #hud {
                padding: 0 10px;
                top: 5px;
            }
            
            .health-label {
                font-size: 0.6rem;
            }
            
            .health-bar {
                height: 20px;
            }
            
            .timer {
                font-size: 1.5rem;
            }
            
            .round-indicator {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.2rem; }
            button { font-size: 0.6rem; padding: 8px 15px; }
            .control-grid { font-size: 0.45rem; }
            
            .dpad-up, .dpad-down, .dpad-left, .dpad-right { width: 45px; height: 45px; }
            .dpad-up { bottom: 110px; left: 60px; }
            .dpad-down { bottom: 20px; left: 60px; }
            .dpad-left { bottom: 65px; left: 15px; }
            .dpad-right { bottom: 65px; left: 105px; }
            
            .btn-punch { bottom: 110px; right: 100px; width: 50px; height: 50px; font-size: 1rem; }
            .btn-kick { bottom: 65px; right: 40px; width: 50px; height: 50px; font-size: 1rem; }
            .btn-block { bottom: 20px; right: 100px; width: 50px; height: 50px; font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Coins Display -->
    <div id="coinsDisplay" class="coins-display hidden">
        ü™ô <span id="coinsAmount">0</span>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="1200" height="600"></canvas>
        
        <!-- Main Menu -->
        <div id="mainMenu">
            <h1>üèÄ LEBRON FIGHTER üëë</h1>
            <p style="margin-bottom: 30px; font-size: 0.9rem;">THE KING'S COURT</p>
            
            <button id="startCampaignButton">CAMPAIGN MODE</button>
            <button id="start2PButtonMain">2 PLAYER VS</button>
            <button id="shopButton">UPGRADE SHOP</button>
            <button onclick="window.location.href='lebronfighter-info.html'" style="background: #333; border-color: #666;">GAME INFO</button>
            <button onclick="window.location.href='index.html'" style="background: #333; border-color: #666;">BACK TO HOME</button>
        </div>

        <!-- Level Select -->
        <div id="levelSelect" class="hidden">
            <h1 class="title-small">SELECT LEVEL</h1>
            <p style="margin-bottom: 20px; font-size: 0.8rem;">FIGHT PROGRESSIVELY HARDER OPPONENTS</p>
            
            <div class="level-grid">
                <button class="level-button" data-level="1">
                    LEVEL 1
                    <span class="difficulty">Easy</span>
                </button>
                <button class="level-button locked" data-level="2">
                    LEVEL 2
                    <span class="difficulty">Medium</span>
                </button>
                <button class="level-button locked" data-level="3">
                    LEVEL 3
                    <span class="difficulty">Hard</span>
                </button>
                <button class="level-button locked" data-level="4">
                    LEVEL 4
                    <span class="difficulty">Very Hard</span>
                </button>
                <button class="level-button locked" data-level="5">
                    LEVEL 5
                    <span class="difficulty">Expert</span>
                </button>
                <button class="level-button locked" data-level="6">
                    LEVEL 6
                    <span class="difficulty">Master</span>
                </button>
            </div>
            
            <button id="backFromLevelSelect" style="background: #333; border-color: #666; margin-top: 20px;">BACK TO MENU</button>
        </div>

        <!-- Shop Screen -->
        <div id="shopScreen" class="hidden">
            <h1 class="title-small">UPGRADE SHOP</h1>
            <p style="margin-bottom: 20px; font-size: 0.8rem;">USE COINS TO UPGRADE YOUR FIGHTER</p>
            
            <div class="stats-panel">
                <h3>YOUR STATS</h3>
                <div class="stat-bar">
                    <label>Attack Power: <span id="statAttack">1</span></label>
                    <div class="stat-bar-fill" id="statAttackBar" style="width: 20%;"></div>
                </div>
                <div class="stat-bar">
                    <label>Max Health: <span id="statHealth">100</span></label>
                    <div class="stat-bar-fill" id="statHealthBar" style="width: 20%;"></div>
                </div>
                <div class="stat-bar">
                    <label>Speed: <span id="statSpeed">1</span></label>
                    <div class="stat-bar-fill" id="statSpeedBar" style="width: 20%;"></div>
                </div>
                <div class="stat-bar">
                    <label>Special Power: <span id="statSpecial">1</span></label>
                    <div class="stat-bar-fill" id="statSpecialBar" style="width: 20%;"></div>
                </div>
            </div>
            
            <div class="shop-grid">
                <div class="shop-item">
                    <h4>ü•ä ATTACK BOOST</h4>
                    <p>Increase punch & kick damage</p>
                    <p>Level: <span id="attackLevel">1</span>/5</p>
                    <p>Cost: <span id="attackCost">50</span> ü™ô</p>
                    <button id="buyAttack">UPGRADE</button>
                </div>
                
                <div class="shop-item">
                    <h4>‚ù§Ô∏è HEALTH BOOST</h4>
                    <p>Increase maximum health</p>
                    <p>Level: <span id="healthLevel">1</span>/5</p>
                    <p>Cost: <span id="healthCost">50</span> ü™ô</p>
                    <button id="buyHealth">UPGRADE</button>
                </div>
                
                <div class="shop-item">
                    <h4>‚ö° SPEED BOOST</h4>
                    <p>Move and attack faster</p>
                    <p>Level: <span id="speedLevel">1</span>/5</p>
                    <p>Cost: <span id="speedCost">50</span> ü™ô</p>
                    <button id="buySpeed">UPGRADE</button>
                </div>
                
                <div class="shop-item">
                    <h4>üî• SPECIAL BOOST</h4>
                    <p>Stronger special moves</p>
                    <p>Level: <span id="specialLevel">1</span>/5</p>
                    <p>Cost: <span id="specialCost">50</span> ü™ô</p>
                    <button id="buySpecial">UPGRADE</button>
                </div>
            </div>
            
            <button id="backFromShop" style="background: #333; border-color: #666; margin-top: 20px;">BACK TO MENU</button>
        </div>
        
        <!-- HUD -->
        <div id="hud" class="hidden">
            <div class="health-container">
                <div class="health-label">LAKERS LEBRON</div>
                <div class="health-bar">
                    <div class="health-fill" id="player1Health" style="width: 100%;"></div>
                </div>
                <div class="special-meter">
                    <div class="special-fill" id="player1Special"></div>
                </div>
                <div class="wins-display" id="player1Wins">
                    <div class="win-dot"></div>
                    <div class="win-dot"></div>
                </div>
            </div>
            
            <div class="center-hud">
                <div class="timer" id="timer">90</div>
                <div class="round-indicator" id="roundIndicator">ROUND 1</div>
            </div>
            
            <div class="health-container">
                <div class="health-label">HEAT LEBRON</div>
                <div class="health-bar">
                    <div class="health-fill" id="player2Health" style="width: 100%;"></div>
                </div>
                <div class="special-meter">
                    <div class="special-fill" id="player2Special"></div>
                </div>
                <div class="wins-display" id="player2Wins">
                    <div class="win-dot"></div>
                    <div class="win-dot"></div>
                </div>
            </div>
        </div>

        <!-- Start Screen (Hidden - now using main menu) -->
        <div id="startScreen" class="hidden">
            <h1>üèÄ LEBRON FIGHTER üëë</h1>
            <p style="margin-bottom: 30px; font-size: 0.9rem;">THE KING'S COURT</p>
            
            <button id="start1PButton">1 PLAYER VS CPU</button>
            <button id="start2PButton">2 PLAYER MODE</button>
            
            <div class="controls">
                <h3>CONTROLS</h3>
                <div class="control-grid">
                    <div>
                        <div class="player-label">PLAYER 1 (LAKERS):</div>
                        W - Jump<br>
                        A - Move Left<br>
                        S - Crouch/Block<br>
                        D - Move Right<br>
                        F - Punch<br>
                        G - Kick<br>
                        H - Block
                    </div>
                    <div>
                        <div class="player-label">PLAYER 2 (HEAT):</div>
                        ‚Üë - Jump<br>
                        ‚Üê - Move Left<br>
                        ‚Üì - Crouch/Block<br>
                        ‚Üí - Move Right<br>
                        J - Punch<br>
                        K - Kick<br>
                        L - Block
                    </div>
                </div>
            </div>
            
            <button onclick="window.location.href='lebronfighter-info.html'" style="background: #333; border-color: #666;">GAME INFO</button>
            <button onclick="window.location.href='index.html'" style="background: #333; border-color: #666;">BACK TO HOME</button>
        </div>

        <!-- Round Screen -->
        <div id="roundScreen" class="hidden">
            <h1 class="title-small" id="roundTitle">ROUND 1</h1>
            <p id="roundSubtext" style="font-size: 1.5rem; color: #fdb927;">FIGHT!</p>
        </div>

        <!-- End Screen -->
        <div id="endScreen" class="hidden">
            <h1 class="title-small" id="endTitle">K.O.!</h1>
            <p class="victory-text" id="winnerText">LAKERS LEBRON WINS!</p>
            <p id="finalScore" style="margin-bottom: 30px;">Score: 0</p>
            <button id="playAgainButton">PLAY AGAIN</button>
            <button onclick="window.location.href='index.html'">BACK TO HOME</button>
        </div>

        <!-- Touch Controls -->
        <div id="touchControls">
            <!-- D-Pad -->
            <div class="touch-button dpad-up" data-action="jump">‚Üë</div>
            <div class="touch-button dpad-down" data-action="down">‚Üì</div>
            <div class="touch-button dpad-left" data-action="left">‚Üê</div>
            <div class="touch-button dpad-right" data-action="right">‚Üí</div>
            
            <!-- Action Buttons -->
            <div class="touch-button btn-punch" data-action="punch">F</div>
            <div class="touch-button btn-kick" data-action="kick">G</div>
            <div class="touch-button btn-block" data-action="block">H</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size
        canvas.width = 1200;
        canvas.height = 600;

        // Game constants
        const GROUND_Y = 450;
        const GRAVITY = 0.8;
        const JUMP_POWER = 15;
        const BASE_SPEED = 5;
        const BASE_PUNCH_DAMAGE = 5;
        const BASE_KICK_DAMAGE = 8;
        const SPECIAL_PROJECTILE_DAMAGE = 15;
        const ULTIMATE_DAMAGE = 25;
        const BLOCK_REDUCTION = 0.3;
        const ROUND_TIME = 90;
        const MAX_HEALTH = 100;
        const DOUBLE_TAP_THRESHOLD = 300;
        const ESTIMATED_GAME_DURATION_MINUTES = 3;
        
        // Level configuration
        const LEVEL_CONFIG = {
            1: { difficulty: 0.5, aiSpeed: 3, aiReactionTime: 60, coinsReward: 50 },
            2: { difficulty: 0.6, aiSpeed: 3.5, aiReactionTime: 50, coinsReward: 75 },
            3: { difficulty: 0.7, aiSpeed: 4, aiReactionTime: 40, coinsReward: 100 },
            4: { difficulty: 0.8, aiSpeed: 4.5, aiReactionTime: 30, coinsReward: 150 },
            5: { difficulty: 0.9, aiSpeed: 5, aiReactionTime: 25, coinsReward: 200 },
            6: { difficulty: 1.0, aiSpeed: 5.5, aiReactionTime: 20, coinsReward: 300 }
        };

        // Game state
        let gameState = 'mainMenu';
        let gameMode = null; // '1P' or '2P'
        let currentRound = 1;
        let roundTime = ROUND_TIME;
        let roundStartTime = 0;
        let comboTimer = 0;
        let comboCounter = 0;
        let flashAlpha = 0;
        let screenShakeX = 0;
        let screenShakeY = 0;
        let particles = [];
        let projectiles = [];
        let currentLevel = 1;
        
        // Player data (for shop/upgrades)
        let playerData = {
            coins: 0,
            attackLevel: 1,
            healthLevel: 1,
            speedLevel: 1,
            specialLevel: 1,
            maxUnlockedLevel: 1
        };

        // Player objects
        let player1 = null;
        let player2 = null;

        // Input handling
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            if (gameState === 'playing') {
                e.preventDefault();
            }
        });
        document.addEventListener('keyup', (e) => {
            keys[e.code] = false;
        });

        // Fighter class
        class Fighter {
            constructor(isPlayer1, isAI = false) {
                this.isPlayer1 = isPlayer1;
                this.isAI = isAI;
                this.reset();
            }
            
            reset() {
                this.x = this.isPlayer1 ? 200 : 1000;
                this.y = GROUND_Y;
                this.width = 50;
                this.height = 80;
                this.velocityX = 0;
                this.velocityY = 0;
                this.direction = this.isPlayer1 ? 1 : -1;
                
                // Health and meters
                const healthBonus = this.isPlayer1 && !this.isAI ? (playerData.healthLevel - 1) * 20 : 0;
                this.maxHealth = MAX_HEALTH + healthBonus;
                this.health = this.maxHealth;
                this.specialMeter = 0;
                this.maxSpecialMeter = 100;
                
                // Combat stats
                const attackBonus = this.isPlayer1 && !this.isAI ? (playerData.attackLevel - 1) * 2 : 0;
                const speedBonus = this.isPlayer1 && !this.isAI ? (playerData.speedLevel - 1) * 0.5 : 0;
                const specialBonus = this.isPlayer1 && !this.isAI ? (playerData.specialLevel - 1) * 3 : 0;
                
                this.punchDamage = BASE_PUNCH_DAMAGE + attackBonus;
                this.kickDamage = BASE_KICK_DAMAGE + attackBonus;
                this.specialDamage = SPECIAL_PROJECTILE_DAMAGE + specialBonus;
                this.ultimateDamage = ULTIMATE_DAMAGE + specialBonus;
                this.speed = BASE_SPEED + speedBonus;
                
                // States
                this.state = 'idle'; // idle, walking, jumping, crouching, blocking, attacking, hit, ko
                this.isBlocking = false;
                this.attackCooldown = 0;
                this.hitStun = 0;
                this.attackFrame = 0;
                this.attackType = null;
                
                // Wins
                this.wins = 0;
                
                // AI properties
                if (this.isAI) {
                    this.aiTimer = 0;
                    this.aiAction = 'idle';
                    this.aiReactionTime = LEVEL_CONFIG[currentLevel].aiReactionTime;
                }
            }
            
            update(opponent) {
                if (this.state === 'ko') return;
                
                // Update cooldowns
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.hitStun > 0) {
                    this.hitStun--;
                    this.state = 'hit';
                    return;
                }
                
                // AI control
                if (this.isAI && gameState === 'playing') {
                    this.updateAI(opponent);
                } else if (!this.isAI) {
                    this.handleInput();
                }
                
                // Update attack animations
                if (this.state === 'attacking') {
                    this.attackFrame++;
                    if (this.attackFrame > 15) {
                        this.state = 'idle';
                        this.attackFrame = 0;
                        this.attackType = null;
                    }
                }
                
                // Physics
                this.velocityY += GRAVITY;
                this.x += this.velocityX;
                this.y += this.velocityY;
                
                // Ground collision
                if (this.y >= GROUND_Y) {
                    this.y = GROUND_Y;
                    this.velocityY = 0;
                    if (this.state === 'jumping') {
                        this.state = 'idle';
                    }
                }
                
                // Screen bounds
                if (this.x < 0) this.x = 0;
                if (this.x > canvas.width - this.width) this.x = canvas.width - this.width;
                
                // Decay velocity
                this.velocityX *= 0.85;
                
                // Update facing direction
                if (opponent && Math.abs(this.velocityX) < 0.1) {
                    this.direction = opponent.x > this.x ? 1 : -1;
                }
            }
            
            handleInput() {
                if (this.hitStun > 0 || this.state === 'attacking') return;
                
                const controls = this.isPlayer1 ? 
                    { left: 'KeyA', right: 'KeyD', up: 'KeyW', down: 'KeyS', punch: 'KeyF', kick: 'KeyG', block: 'KeyH' } :
                    { left: 'ArrowLeft', right: 'ArrowRight', up: 'ArrowUp', down: 'ArrowDown', punch: 'KeyJ', kick: 'KeyK', block: 'KeyL' };
                
                // Block
                this.isBlocking = (keys[controls.down] || keys[controls.block]) && this.y >= GROUND_Y;
                if (this.isBlocking) {
                    this.state = 'blocking';
                    return;
                }
                
                // Movement
                if (keys[controls.left]) {
                    this.velocityX = -this.speed;
                    if (this.y >= GROUND_Y) this.state = 'walking';
                } else if (keys[controls.right]) {
                    this.velocityX = this.speed;
                    if (this.y >= GROUND_Y) this.state = 'walking';
                } else if (this.y >= GROUND_Y && this.state !== 'attacking') {
                    this.state = 'idle';
                }
                
                // Jump
                if (keys[controls.up] && this.y >= GROUND_Y) {
                    this.velocityY = -JUMP_POWER;
                    this.state = 'jumping';
                }
                
                // Attacks
                if (this.attackCooldown <= 0) {
                    if (keys[controls.punch]) {
                        this.attack('punch');
                    } else if (keys[controls.kick]) {
                        this.attack('kick');
                    }
                }
            }
            
            updateAI(opponent) {
                if (!opponent) return;
                
                this.aiTimer++;
                const levelConfig = LEVEL_CONFIG[currentLevel] || LEVEL_CONFIG[1];
                
                // Make decisions periodically
                if (this.aiTimer % this.aiReactionTime === 0) {
                    const distance = Math.abs(this.x - opponent.x);
                    const healthRatio = this.health / this.maxHealth;
                    
                    // Decide action based on distance and health
                    if (distance > 200) {
                        this.aiAction = Math.random() < 0.7 ? 'approach' : 'projectile';
                    } else if (distance > 100) {
                        this.aiAction = Math.random() < 0.5 ? 'approach' : 'attack';
                    } else {
                        if (healthRatio < 0.3 && Math.random() < 0.4) {
                            this.aiAction = 'block';
                        } else {
                            this.aiAction = Math.random() < 0.7 ? 'attack' : 'retreat';
                        }
                    }
                }
                
                // Execute action
                this.isBlocking = false;
                
                switch (this.aiAction) {
                    case 'approach':
                        if (opponent.x > this.x) {
                            this.velocityX = levelConfig.aiSpeed;
                        } else {
                            this.velocityX = -levelConfig.aiSpeed;
                        }
                        this.state = 'walking';
                        break;
                        
                    case 'retreat':
                        if (opponent.x > this.x) {
                            this.velocityX = -levelConfig.aiSpeed * 0.7;
                        } else {
                            this.velocityX = levelConfig.aiSpeed * 0.7;
                        }
                        this.state = 'walking';
                        break;
                        
                    case 'block':
                        this.isBlocking = true;
                        this.state = 'blocking';
                        break;
                        
                    case 'attack':
                        if (this.attackCooldown <= 0) {
                            const rand = Math.random();
                            if (rand < 0.4) {
                                this.attack('punch');
                            } else if (rand < 0.7) {
                                this.attack('kick');
                            } else {
                                this.attack('special');
                            }
                        }
                        break;
                        
                    case 'projectile':
                        if (this.attackCooldown <= 0 && this.specialMeter >= 30) {
                            this.attack('special');
                        } else {
                            this.aiAction = 'approach';
                        }
                        break;
                }
                
                // Occasionally jump
                if (Math.random() < 0.01 * levelConfig.difficulty && this.y >= GROUND_Y) {
                    this.velocityY = -JUMP_POWER;
                    this.state = 'jumping';
                }
            }
            
            attack(type) {
                this.state = 'attacking';
                this.attackFrame = 0;
                this.attackType = type;
                this.attackCooldown = type === 'kick' ? 25 : 15;
                
                if (type === 'special') {
                    if (this.specialMeter >= 100) {
                        // Ultimate
                        this.specialMeter = 0;
                        this.attackType = 'ultimate';
                        this.attackCooldown = 40;
                    } else if (this.specialMeter >= 30) {
                        // Projectile
                        this.specialMeter -= 30;
                        this.shootProjectile();
                    } else {
                        // Not enough meter
                        this.state = 'idle';
                        this.attackCooldown = 0;
                    }
                }
            }
            
            shootProjectile() {
                projectiles.push({
                    x: this.x + (this.direction > 0 ? this.width : 0),
                    y: this.y + this.height / 2,
                    direction: this.direction,
                    speed: 12,
                    damage: this.specialDamage,
                    owner: this
                });
                createParticles(this.x + this.width / 2, this.y + this.height / 2, '#ff6b35', 15);
            }
            
            takeDamage(damage, attacker) {
                if (this.state === 'ko') return;
                
                let actualDamage = damage;
                
                if (this.isBlocking) {
                    actualDamage *= BLOCK_REDUCTION;
                    createParticles(this.x + this.width / 2, this.y + this.height / 2, '#4444ff', 8);
                } else {
                    this.hitStun = 10;
                    createParticles(this.x + this.width / 2, this.y + this.height / 2, '#ff0000', 12);
                    
                    // Combo system
                    if (attacker === player1 || attacker === player2) {
                        if (Date.now() - comboTimer < 2000) {
                            comboCounter++;
                        } else {
                            comboCounter = 1;
                        }
                        comboTimer = Date.now();
                    }
                }
                
                this.health -= actualDamage;
                flashAlpha = 0.3;
                
                // Screen shake on heavy hits
                if (damage >= 20) {
                    screenShakeX = (Math.random() - 0.5) * 20;
                    screenShakeY = (Math.random() - 0.5) * 20;
                }
                
                // Gain special meter
                if (attacker) {
                    attacker.specialMeter = Math.min(attacker.maxSpecialMeter, attacker.specialMeter + damage);
                }
                this.specialMeter = Math.min(this.maxSpecialMeter, this.specialMeter + damage * 0.5);
                
                if (this.health <= 0) {
                    this.health = 0;
                    this.state = 'ko';
                    createParticles(this.x + this.width / 2, this.y + this.height / 2, '#fdb927', 30);
                }
                
                updateHealthBars();
            }
            
            draw() {
                ctx.save();
                
                // Determine color based on player
                const primaryColor = this.isPlayer1 ? '#552583' : '#98002e'; // Lakers purple vs Heat red
                const secondaryColor = this.isPlayer1 ? '#fdb927' : '#000000'; // Lakers gold vs Heat black
                
                // Draw shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(this.x + this.width / 2, GROUND_Y + this.height + 5, this.width / 2, 10, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Flip for direction
                if (this.direction < 0) {
                    ctx.translate(this.x + this.width, this.y);
                    ctx.scale(-1, 1);
                    ctx.translate(-this.x, -this.y);
                }
                
                // Flash effect when hit
                if (this.hitStun > 0 && this.hitStun % 4 < 2) {
                    ctx.globalAlpha = 0.5;
                }
                
                // Draw body
                ctx.fillStyle = primaryColor;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Draw number 23
                ctx.fillStyle = secondaryColor;
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('23', this.x + this.width / 2, this.y + 45);
                
                // Draw head
                ctx.fillStyle = '#8B4513';
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y - 15, 18, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw crown
                ctx.font = '20px Arial';
                ctx.fillText('üëë', this.x + this.width / 2, this.y - 25);
                
                // Draw attack indicators
                if (this.state === 'attacking' && this.attackFrame < 8) {
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.5)';
                    const attackX = this.x + (this.direction > 0 ? this.width : -30);
                    const attackY = this.attackType === 'kick' ? this.y + 40 : this.y + 20;
                    ctx.fillRect(attackX, attackY, 30, 20);
                }
                
                // Draw blocking indicator
                if (this.isBlocking) {
                    ctx.strokeStyle = '#4444ff';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(this.x - 5, this.y - 5, this.width + 10, this.height + 10);
                }
                
                ctx.restore();
            }
        }

        // Particle effects
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + 2;
                this.speedX = Math.random() * 8 - 4;
                this.speedY = Math.random() * 8 - 4;
                this.color = color;
                this.life = 30;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += 0.3; // Gravity
                this.life--;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 30;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        function createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }
        
        // Utility functions
        function isTouchDevice() {
            return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }
        
        function checkCollision(rect1, rect2, range = 0) {
            return rect1.x < rect2.x + rect2.width + range &&
                   rect1.x + rect1.width + range > rect2.x &&
                   rect1.y < rect2.y + rect2.height + range &&
                   rect1.y + rect1.height + range > rect2.y;
        }

        // Game update function
        function update() {
            if (gameState !== 'playing') return;
            
            // Update round timer
            const elapsed = (Date.now() - roundStartTime) / 1000;
            roundTime = Math.max(0, ROUND_TIME - elapsed);
            document.getElementById('timer').textContent = Math.ceil(roundTime);
            
            // Check time out
            if (roundTime <= 0 && gameState === 'playing') {
                endRound();
                return;
            }
            
            // Update fighters
            if (player1 && player2) {
                player1.update(player2);
                player2.update(player1);
                
                // Check attack collisions
                checkAttackCollisions();
                
                // Update projectiles
                updateProjectiles();
                
                // Update particles
                particles = particles.filter(p => {
                    p.update();
                    return p.life > 0;
                });
                
                // Update special meter displays
                updateSpecialMeters();
                
                // Check for KO
                if (player1.health <= 0 || player2.health <= 0) {
                    if (gameState === 'playing') {
                        endRound();
                    }
                }
            }
            
            // Decay screen shake
            screenShakeX *= 0.8;
            screenShakeY *= 0.8;
            if (Math.abs(screenShakeX) < 0.1) screenShakeX = 0;
            if (Math.abs(screenShakeY) < 0.1) screenShakeY = 0;
        }
        
        function checkAttackCollisions() {
            // Player 1 attacks Player 2
            if (player1.state === 'attacking' && player1.attackFrame >= 3 && player1.attackFrame <= 8) {
                const attackRange = player1.attackType === 'ultimate' ? 100 : 60;
                const distance = Math.abs(player1.x - player2.x);
                
                if (distance < attackRange && Math.abs(player1.y - player2.y) < 80) {
                    let damage = 0;
                    if (player1.attackType === 'punch') damage = player1.punchDamage;
                    else if (player1.attackType === 'kick') damage = player1.kickDamage;
                    else if (player1.attackType === 'ultimate') damage = player1.ultimateDamage;
                    
                    if (damage > 0 && player1.attackFrame === 5) {
                        player2.takeDamage(damage, player1);
                    }
                }
            }
            
            // Player 2 attacks Player 1
            if (player2.state === 'attacking' && player2.attackFrame >= 3 && player2.attackFrame <= 8) {
                const attackRange = player2.attackType === 'ultimate' ? 100 : 60;
                const distance = Math.abs(player2.x - player1.x);
                
                if (distance < attackRange && Math.abs(player2.y - player1.y) < 80) {
                    let damage = 0;
                    if (player2.attackType === 'punch') damage = player2.punchDamage;
                    else if (player2.attackType === 'kick') damage = player2.kickDamage;
                    else if (player2.attackType === 'ultimate') damage = player2.ultimateDamage;
                    
                    if (damage > 0 && player2.attackFrame === 5) {
                        player1.takeDamage(damage, player2);
                    }
                }
            }
        }
        
        function updateProjectiles() {
            projectiles = projectiles.filter(proj => {
                proj.x += proj.speed * proj.direction;
                
                // Check collision with opponent
                const opponent = proj.owner === player1 ? player2 : player1;
                const hit = checkCollision(
                    { x: proj.x - 15, y: proj.y - 15, width: 30, height: 30 },
                    opponent,
                    10
                );
                
                if (hit) {
                    opponent.takeDamage(proj.damage, proj.owner);
                    return false;
                }
                
                // Remove if off screen
                return proj.x > -50 && proj.x < canvas.width + 50;
            });
        }
        
        // Game draw function
        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Apply screen shake
            ctx.save();
            ctx.translate(screenShakeX, screenShakeY);
            
            // Draw background court
            drawCourt();
            
            // Draw projectiles
            projectiles.forEach(proj => {
                ctx.fillStyle = '#ff6b35';
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, 15, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
            
            // Draw fighters
            if (player1) player1.draw();
            if (player2) player2.draw();
            
            // Draw particles
            particles.forEach(p => p.draw());
            
            // Draw combo counter
            if (Date.now() - comboTimer < 2000 && comboCounter > 1) {
                ctx.fillStyle = '#fdb927';
                ctx.font = 'bold 30px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.strokeStyle = '#552583';
                ctx.lineWidth = 4;
                ctx.strokeText(`${comboCounter} HIT COMBO!`, canvas.width / 2, 100);
                ctx.fillText(`${comboCounter} HIT COMBO!`, canvas.width / 2, 100);
            }
            
            // Flash effect
            if (flashAlpha > 0) {
                ctx.fillStyle = `rgba(255, 255, 255, ${flashAlpha})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                flashAlpha *= 0.85;
            }
            
            ctx.restore();
        }
        
        function drawCourt() {
            // Draw court lines
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw 3-point lines
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(100, canvas.height - 50, 80, -Math.PI / 2, Math.PI / 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(canvas.width - 100, canvas.height - 50, 80, Math.PI / 2, -Math.PI / 2);
            ctx.stroke();
            
            // Draw ground line
            ctx.strokeStyle = '#8b4513';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, GROUND_Y + 80);
            ctx.lineTo(canvas.width, GROUND_Y + 80);
            ctx.stroke();
            
            // Draw court floor pattern
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(i, GROUND_Y + 80);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
        }

        // Game loop
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Game flow functions
        function startGame(mode) {
            gameMode = mode;
            gameState = 'playing';
            currentRound = 1;
            
            // Create fighters
            player1 = new Fighter(true, false);
            player2 = new Fighter(false, mode === '1P');
            
            player1.wins = 0;
            player2.wins = 0;
            
            startRound();
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            // Show touch controls on mobile
            if (isTouchDevice()) {
                document.getElementById('touchControls').classList.add('active');
            }
        }

        function startRound() {
            player1.reset();
            player2.reset();
            roundTime = ROUND_TIME;
            roundStartTime = Date.now();
            comboCounter = 0;
            comboTimer = 0;
            
            document.getElementById('roundIndicator').textContent = `ROUND ${currentRound}`;
            
            // Show round screen
            document.getElementById('roundTitle').textContent = `ROUND ${currentRound}`;
            document.getElementById('roundSubtext').textContent = 'FIGHT!';
            const roundScreen = document.getElementById('roundScreen');
            roundScreen.classList.remove('hidden');
            
            setTimeout(() => {
                roundScreen.classList.add('hidden');
            }, 2000);
        }

        // UI update functions
        function updateHealthBars() {
            if (!player1 || !player2) return;
            
            const p1HealthPercent = (player1.health / player1.maxHealth) * 100;
            const p2HealthPercent = (player2.health / player2.maxHealth) * 100;
            
            document.getElementById('player1Health').style.width = p1HealthPercent + '%';
            document.getElementById('player2Health').style.width = p2HealthPercent + '%';
        }
        
        function updateSpecialMeters() {
            if (!player1 || !player2) return;
            
            const p1SpecialPercent = (player1.specialMeter / player1.maxSpecialMeter) * 100;
            const p2SpecialPercent = (player2.specialMeter / player2.maxSpecialMeter) * 100;
            
            document.getElementById('player1Special').style.width = p1SpecialPercent + '%';
            document.getElementById('player2Special').style.width = p2SpecialPercent + '%';
        }
        
        function updateWinDots() {
            // Player 1 wins
            const p1Dots = document.querySelectorAll('#player1Wins .win-dot');
            p1Dots.forEach((dot, i) => {
                if (i < player1.wins) {
                    dot.classList.add('won');
                } else {
                    dot.classList.remove('won');
                }
            });
            
            // Player 2 wins
            const p2Dots = document.querySelectorAll('#player2Wins .win-dot');
            p2Dots.forEach((dot, i) => {
                if (i < player2.wins) {
                    dot.classList.add('won');
                } else {
                    dot.classList.remove('won');
                }
            });
        }
        
        function endRound() {
            gameState = 'roundEnd';
            
            // Determine winner
            let roundWinner;
            if (player1.health > player2.health) {
                player1.wins++;
                roundWinner = 1;
            } else if (player2.health > player1.health) {
                player2.wins++;
                roundWinner = 2;
            } else {
                // Tie, both get a win
                player1.wins++;
                player2.wins++;
            }
            
            updateWinDots();
            
            // Check if match is over
            if (player1.wins >= 2 || player2.wins >= 2) {
                setTimeout(endMatch, 2000);
            } else {
                currentRound++;
                setTimeout(() => {
                    gameState = 'playing';
                    startRound();
                }, 3000);
            }
        }

        function endMatch() {
            gameState = 'gameEnd';
            
            const playerWon = player1.wins >= 2;
            const winner = playerWon ? 'LAKERS LEBRON' : 'HEAT LEBRON';
            const score = Math.max(player1.wins, player2.wins) * 1000;
            
            // Award coins if player won in campaign mode
            let coinsEarned = 0;
            if (gameMode === '1P' && playerWon) {
                const levelConfig = LEVEL_CONFIG[currentLevel] || LEVEL_CONFIG[1];
                coinsEarned = levelConfig.coinsReward;
                playerData.coins += coinsEarned;
                
                // Unlock next level
                if (currentLevel === playerData.maxUnlockedLevel && currentLevel < 6) {
                    playerData.maxUnlockedLevel = currentLevel + 1;
                }
                
                savePlayerData();
                updateCoinsDisplay();
            }
            
            document.getElementById('endTitle').textContent = playerWon ? 'VICTORY!' : 'K.O.!';
            document.getElementById('winnerText').textContent = `${winner} WINS!`;
            
            let scoreText = `Score: ${score}`;
            if (coinsEarned > 0) {
                scoreText += `\n+${coinsEarned} Coins Earned!`;
            }
            document.getElementById('finalScore').textContent = scoreText;
            document.getElementById('endScreen').classList.remove('hidden');
            
            // Submit score to leaderboard
            try {
                if (typeof submitScoreToLeaderboard === 'function') {
                    submitScoreToLeaderboard('LeBronFighter', score, 'normal');
                }
            } catch (e) {
                console.log('Could not submit score to leaderboard:', e);
            }
            
            // Save to localStorage
            try {
                const existingData = localStorage.getItem('lebronfighterGameData');
                const data = existingData ? JSON.parse(existingData) : { gamesPlayed: 0, score: 0, playtime: 0 };
                
                data.gamesPlayed = (data.gamesPlayed || 0) + 1;
                data.score = Math.max(data.score || 0, score);
                data.playtime = (data.playtime || 0) + ESTIMATED_GAME_DURATION_MINUTES;
                
                localStorage.setItem('lebronfighterGameData', JSON.stringify(data));
            } catch (e) {
                console.log('Could not save game data:', e);
            }
        }

        function resetGame() {
            gameState = 'mainMenu';
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('touchControls').classList.remove('active');
            document.getElementById('coinsDisplay').classList.remove('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
        }
        
        // Save/Load player data
        function savePlayerData() {
            try {
                localStorage.setItem('lebronFighterPlayerData', JSON.stringify(playerData));
            } catch (e) {
                console.log('Could not save player data:', e);
            }
        }
        
        function loadPlayerData() {
            try {
                const saved = localStorage.getItem('lebronFighterPlayerData');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    playerData = { ...playerData, ...loaded };
                }
            } catch (e) {
                console.log('Could not load player data:', e);
            }
            updateCoinsDisplay();
            updateShopUI();
            updateLevelSelect();
        }
        
        // UI Update functions
        function updateCoinsDisplay() {
            document.getElementById('coinsAmount').textContent = playerData.coins;
        }
        
        function updateShopUI() {
            // Update stat displays
            document.getElementById('statAttack').textContent = playerData.attackLevel;
            document.getElementById('statHealth').textContent = MAX_HEALTH * playerData.healthLevel;
            document.getElementById('statSpeed').textContent = playerData.speedLevel;
            document.getElementById('statSpecial').textContent = playerData.specialLevel;
            
            // Update stat bars
            document.getElementById('statAttackBar').style.width = (playerData.attackLevel * 20) + '%';
            document.getElementById('statHealthBar').style.width = (playerData.healthLevel * 20) + '%';
            document.getElementById('statSpeedBar').style.width = (playerData.speedLevel * 20) + '%';
            document.getElementById('statSpecialBar').style.width = (playerData.specialLevel * 20) + '%';
            
            // Update shop items
            updateShopItem('attack', playerData.attackLevel);
            updateShopItem('health', playerData.healthLevel);
            updateShopItem('speed', playerData.speedLevel);
            updateShopItem('special', playerData.specialLevel);
        }
        
        function updateShopItem(type, level) {
            // costs[i] = cost to upgrade FROM level i TO level i+1
            // e.g., costs[1] = 50 coins to go from level 1 to level 2
            const costs = [0, 50, 100, 200, 400, 800];
            const nextCost = level < 5 ? costs[level] : 0;
            
            document.getElementById(`${type}Level`).textContent = level;
            document.getElementById(`${type}Cost`).textContent = nextCost;
            
            const button = document.getElementById(`buy${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (level >= 5) {
                button.textContent = 'MAX';
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            } else if (playerData.coins < nextCost) {
                button.disabled = true;
                button.style.opacity = '0.7';
            } else {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        }
        
        function updateLevelSelect() {
            const buttons = document.querySelectorAll('.level-button');
            buttons.forEach((button, index) => {
                const level = index + 1;
                if (level <= playerData.maxUnlockedLevel) {
                    button.classList.remove('locked');
                    button.disabled = false;
                    button.style.cursor = 'pointer';
                } else {
                    button.classList.add('locked');
                    button.disabled = true;
                }
            });
        }
        
        // Navigation functions
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('levelSelect').classList.add('hidden');
            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('coinsDisplay').classList.remove('hidden');
            gameState = 'mainMenu';
        }
        
        function showLevelSelect() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('levelSelect').classList.remove('hidden');
            updateLevelSelect();
        }
        
        function showShop() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('shopScreen').classList.remove('hidden');
            updateShopUI();
        }
        
        function buyUpgrade(type) {
            // costs[i] = cost to upgrade FROM level i TO level i+1
            const costs = [0, 50, 100, 200, 400, 800];
            const currentLevel = playerData[`${type}Level`];
            
            if (currentLevel >= 5) return; // Max level
            
            const cost = costs[currentLevel];
            if (playerData.coins >= cost) {
                playerData.coins -= cost;
                playerData[`${type}Level`]++;
                savePlayerData();
                updateCoinsDisplay();
                updateShopUI();
            }
        }

        // Touch controls setup
        function setupTouchControls() {
            const touchButtons = document.querySelectorAll('.touch-button');
            
            touchButtons.forEach(button => {
                const action = button.getAttribute('data-action');
                
                // Map touch actions to keyboard keys
                const keyMap = {
                    'left': 'KeyA',
                    'right': 'KeyD',
                    'jump': 'KeyW',
                    'down': 'KeyS',
                    'block': 'KeyH',
                    'punch': 'KeyF',
                    'kick': 'KeyG'
                };
                
                const keyCode = keyMap[action];
                
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (keyCode) {
                        keys[keyCode] = true;
                    }
                });
                
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (keyCode) {
                        keys[keyCode] = false;
                    }
                });
                
                button.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    if (keyCode) {
                        keys[keyCode] = false;
                    }
                });
            });
        }
        
        // Event listeners
        document.getElementById('start1PButton').addEventListener('click', () => startGame('1P'));
        document.getElementById('start2PButton').addEventListener('click', () => startGame('2P'));
        document.getElementById('start2PButtonMain').addEventListener('click', () => {
            gameMode = '2P';
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('coinsDisplay').classList.add('hidden');
            startGame('2P');
        });
        document.getElementById('playAgainButton').addEventListener('click', () => {
            resetGame();
        });
        
        // Main menu buttons
        document.getElementById('startCampaignButton').addEventListener('click', () => {
            showLevelSelect();
        });
        
        document.getElementById('shopButton').addEventListener('click', () => {
            showShop();
        });
        
        // Level select
        document.querySelectorAll('.level-button').forEach(button => {
            button.addEventListener('click', () => {
                if (!button.classList.contains('locked')) {
                    currentLevel = parseInt(button.getAttribute('data-level'));
                    gameMode = '1P';
                    document.getElementById('levelSelect').classList.add('hidden');
                    document.getElementById('coinsDisplay').classList.add('hidden');
                    startGame('1P');
                }
            });
        });
        
        document.getElementById('backFromLevelSelect').addEventListener('click', () => {
            showMainMenu();
        });
        
        // Shop buttons
        document.getElementById('buyAttack').addEventListener('click', () => buyUpgrade('attack'));
        document.getElementById('buyHealth').addEventListener('click', () => buyUpgrade('health'));
        document.getElementById('buySpeed').addEventListener('click', () => buyUpgrade('speed'));
        document.getElementById('buySpecial').addEventListener('click', () => buyUpgrade('special'));
        
        document.getElementById('backFromShop').addEventListener('click', () => {
            showMainMenu();
        });

        // Initialize touch controls
        setupTouchControls();

        // Prevent zoom on double tap for mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= DOUBLE_TAP_THRESHOLD) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Prevent pull-to-refresh
        document.body.addEventListener('touchmove', (e) => {
            if (gameState === 'playing') {
                e.preventDefault();
            }
        }, { passive: false });

        // Initialize game
        loadPlayerData();
        showMainMenu();
        
        // Start game loop
        gameLoop();
    </script>
</body>
</html>
